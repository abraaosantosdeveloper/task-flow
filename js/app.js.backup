// ============================================
// Task App - Main Functionality
// ============================================

// State
let tasks = [];
let currentFilter = 'all';

// Elements (will be initialized after DOM loads)
let taskForm, taskInput, tasksList, emptyState, filterTabs, clearCompletedBtn;
let userMenuBtn, userDropdown, themeToggle, toast, toastMessage, userEmailDisplay;

document.addEventListener('DOMContentLoaded', () => {
    console.log('App iniciado');
    
    // Initialize elements
    taskForm = document.getElementById('taskForm');
    taskInput = document.getElementById('taskInput');
    tasksList = document.getElementById('tasksList');
    emptyState = document.getElementById('emptyState');
    filterTabs = document.querySelectorAll('.filter-tab');
    clearCompletedBtn = document.getElementById('clearCompleted');
    userMenuBtn = document.getElementById('userMenuBtn');
    userDropdown = document.getElementById('userDropdown');
    themeToggle = document.getElementById('themeToggle');
    toast = document.getElementById('toast');
    toastMessage = document.getElementById('toastMessage');
    userEmailDisplay = document.getElementById('userEmail');
    
    console.log('Elementos inicializados');
    
    // Check if user is logged in
    checkAuth();

    // Load tasks from localStorage
    tasks = loadTasks();
    console.log('Tarefas carregadas do localStorage:', tasks);

    // ============================================
    // Authentication Check
    // ============================================
    function checkAuth() {
        const userEmail = localStorage.getItem('userEmail');
        if (!userEmail) {
            console.log('Usu치rio n칚o autenticado, redirecionando...');
            window.location.href = 'login.html';
            return;
        }
        
        console.log('Usu치rio autenticado:', userEmail);
        
        // Display user email
        if (userEmailDisplay) {
            userEmailDisplay.textContent = userEmail;
        }
    }

    // ============================================
    // User Menu
    // ============================================
    userMenuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        userDropdown.classList.toggle('show');
    });

    document.addEventListener('click', (e) => {
        if (!userDropdown.contains(e.target) && !userMenuBtn.contains(e.target)) {
            userDropdown.classList.remove('show');
        }
    });

    // Logout
    const logoutLinks = document.querySelectorAll('.logout');
    logoutLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('userEmail');
            window.location.href = 'login.html';
        });
    });

    // ============================================
    // Theme Toggle
    // ============================================
    const savedTheme = localStorage.getItem('theme') || 'light';
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-theme');
        themeToggle.querySelector('i').classList.replace('bx-moon', 'bx-sun');
    }

    themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-theme');
        const isDark = document.body.classList.contains('dark-theme');
        
        const icon = themeToggle.querySelector('i');
        if (isDark) {
            icon.classList.replace('bx-moon', 'bx-sun');
            localStorage.setItem('theme', 'dark');
        } else {
            icon.classList.replace('bx-sun', 'bx-moon');
            localStorage.setItem('theme', 'light');
        }
    });

    // ============================================
    // Task Management
    // ============================================
    
    // Add Task
    taskForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const text = taskInput.value.trim();
        if (text === '') return;
        
        const task = {
            id: Date.now(),
            text: text,
            completed: false,
            createdAt: new Date().toISOString()
        };
        
        tasks.unshift(task);
        saveTasks();
        renderTasks();
        taskInput.value = '';
        
        showToast('Tarefa adicionada com sucesso!', 'success');
    });

    // Toggle Task Completion
    function toggleTask(id) {
        const task = tasks.find(t => t.id === id);
        if (task) {
            task.completed = !task.completed;
            saveTasks();
            renderTasks();
            
            const message = task.completed ? 'Tarefa conclu칤da!' : 'Tarefa reaberta!';
            showToast(message, 'success');
        }
    }

    // Delete Task
    function deleteTask(id) {
        tasks = tasks.filter(t => t.id !== id);
        saveTasks();
        renderTasks();
        showToast('Tarefa removida!', 'success');
    }

    // Clear Completed Tasks
    clearCompletedBtn.addEventListener('click', () => {
        const completedCount = tasks.filter(t => t.completed).length;
        
        if (completedCount === 0) {
            showToast('Nenhuma tarefa conclu칤da para limpar', 'info');
            return;
        }
        
        if (confirm(`Deseja remover ${completedCount} tarefa(s) conclu칤da(s)?`)) {
            tasks = tasks.filter(t => !t.completed);
            saveTasks();
            renderTasks();
            showToast(`${completedCount} tarefa(s) removida(s)!`, 'success');
        }
    });

    // ============================================
    // Filter Tasks
    // ============================================
    filterTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            filterTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            currentFilter = tab.dataset.filter;
            renderTasks();
        });
    });

    function getFilteredTasks() {
        switch (currentFilter) {
            case 'pending':
                return tasks.filter(t => !t.completed);
            case 'completed':
                return tasks.filter(t => t.completed);
            default:
                return tasks;
        }
    }

    // ============================================
    // Render Tasks
    // ============================================
    function renderTasks() {
        console.log('renderTasks chamada');
        const filteredTasks = getFilteredTasks();
        console.log('Tarefas filtradas:', filteredTasks.length);
        
        // Update stats
        updateStats();
        
        // Clear list
        tasksList.innerHTML = '';
        console.log('Lista limpa');
        
        // Show/hide empty state
        if (filteredTasks.length === 0) {
            console.log('Nenhuma tarefa para exibir, mostrando empty state');
            emptyState.classList.add('show');
            tasksList.style.display = 'none';
            return;
        } else {
            console.log('Exibindo tarefas...');
            emptyState.classList.remove('show');
            tasksList.style.display = 'flex';
        }
        
        // Render tasks
        filteredTasks.forEach(task => {
            console.log('Renderizando tarefa:', task.text);
            const taskItem = createTaskElement(task);
            tasksList.appendChild(taskItem);
        });
        
        console.log('Tarefas renderizadas com sucesso!');
    }

    function createTaskElement(task) {
        const taskItem = document.createElement('div');
        taskItem.className = `task-item ${task.completed ? 'completed' : ''}`;
        taskItem.dataset.id = task.id;
        
        const timeAgo = getTimeAgo(task.createdAt);
        
        taskItem.innerHTML = `
            <input 
                type="checkbox" 
                class="task-checkbox" 
                ${task.completed ? 'checked' : ''}
                data-id="${task.id}"
            >
            <div class="task-content">
                <p class="task-text" contenteditable="false">${escapeHtml(task.text)}</p>
                <span class="task-time">${timeAgo}</span>
            </div>
            <div class="task-actions">
                <button class="btn-task edit" data-id="${task.id}" aria-label="Editar tarefa">
                    <i class='bx bx-edit'></i>
                </button>
                <button class="btn-task delete" data-id="${task.id}" aria-label="Excluir tarefa">
                    <i class='bx bx-trash'></i>
                </button>
            </div>
        `;
        
        // Event listeners
        const checkbox = taskItem.querySelector('.task-checkbox');
        checkbox.addEventListener('change', () => toggleTask(task.id));
        
        const editBtn = taskItem.querySelector('.edit');
        editBtn.addEventListener('click', () => editTask(task.id, taskItem));
        
        const deleteBtn = taskItem.querySelector('.delete');
        deleteBtn.addEventListener('click', () => deleteTask(task.id));
        
        return taskItem;
    }

    // Edit Task
    function editTask(id, taskItem) {
        const taskText = taskItem.querySelector('.task-text');
        const editBtn = taskItem.querySelector('.edit');
        const isEditing = taskText.contentEditable === 'true';
        
        if (isEditing) {
            // Save changes
            const newText = taskText.textContent.trim();
            
            if (newText === '') {
                showToast('Tarefa n칚o pode estar vazia', 'error');
                // Restore original text
                const task = tasks.find(t => t.id === id);
                taskText.textContent = task.text;
                taskText.contentEditable = 'false';
                taskItem.classList.remove('editing');
                editBtn.innerHTML = '<i class="bx bx-edit"></i>';
                return;
            }
            
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.text = newText;
                saveTasks();
                taskText.contentEditable = 'false';
                taskItem.classList.remove('editing');
                editBtn.innerHTML = '<i class="bx bx-edit"></i>';
                showToast('Tarefa atualizada!', 'success');
            }
        } else {
            // Enter edit mode
            taskText.contentEditable = 'true';
            taskText.focus();
            taskItem.classList.add('editing');
            editBtn.innerHTML = '<i class="bx bx-check"></i>';
            
            // Select all text
            const range = document.createRange();
            range.selectNodeContents(taskText);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            // Save on Enter, cancel on Escape
            taskText.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    editBtn.click();
                } else if (e.key === 'Escape') {
                    const task = tasks.find(t => t.id === id);
                    taskText.textContent = task.text;
                    taskText.contentEditable = 'false';
                    taskItem.classList.remove('editing');
                    editBtn.innerHTML = '<i class="bx bx-edit"></i>';
                }
            });
        }
    }

    // ============================================
    // Update Statistics
    // ============================================
    function updateStats() {
        // Recarrega do localStorage para garantir sincroniza칞칚o
        const currentTasks = loadTasks();
        const total = currentTasks.length;
        const completed = currentTasks.filter(t => t.completed).length;
        const pending = total - completed;
        
        const totalElement = document.getElementById('totalTasks');
        const pendingElement = document.getElementById('pendingTasks');
        const completedElement = document.getElementById('completedTasks');
        
        if (totalElement) totalElement.textContent = total;
        if (pendingElement) pendingElement.textContent = pending;
        if (completedElement) completedElement.textContent = completed;
        
        console.log('Stats atualizadas - Total:', total, 'Pendentes:', pending, 'Conclu칤das:', completed);
    }

    // ============================================
    // Local Storage
    // ============================================
    function saveTasks() {
        try {
            const tasksJson = JSON.stringify(tasks);
            localStorage.setItem('tasks', tasksJson);
            console.log('Tarefas salvas no localStorage:', tasks.length, 'tarefas');
        } catch (error) {
            console.error('Erro ao salvar tarefas:', error);
            showToast('Erro ao salvar tarefas', 'error');
        }
    }

    function loadTasks() {
        try {
            const stored = localStorage.getItem('tasks');
            if (stored) {
                const parsed = JSON.parse(stored);
                console.log('Tarefas carregadas do localStorage:', parsed.length, 'tarefas');
                return parsed;
            } else {
                console.log('Nenhuma tarefa encontrada no localStorage');
                return [];
            }
        } catch (error) {
            console.error('Erro ao carregar tarefas:', error);
            return [];
        }
    }

    // ============================================
    // Toast Notification
    // ============================================
    function showToast(message, type = 'success') {
        toastMessage.textContent = message;
        
        const icon = toast.querySelector('i');
        icon.className = 'bx';
        
        switch (type) {
            case 'success':
                icon.classList.add('bx-check-circle');
                break;
            case 'error':
                icon.classList.add('bx-error-circle');
                break;
            case 'info':
                icon.classList.add('bx-info-circle');
                break;
        }
        
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    // ============================================
    // Utility Functions
    // ============================================
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function getTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);
        
        if (seconds < 60) return 'Agora mesmo';
        
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes} min atr치s`;
        
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h atr치s`;
        
        const days = Math.floor(hours / 24);
        if (days === 1) return 'Ontem';
        if (days < 7) return `${days} dias atr치s`;
        
        return date.toLocaleDateString('pt-BR', { 
            day: '2-digit', 
            month: 'short' 
        });
    }

    // ============================================
    // Initialize
    // ============================================
    console.log('Inicializando app...');
    
    // Add some demo tasks if empty (optional)
    if (tasks.length === 0) {
        console.log('Nenhuma tarefa encontrada, criando tarefas demo');
        const demoTasks = [
            { id: Date.now() + 1, text: 'Bem-vindo ao TaskFlow! 游녦', completed: false, createdAt: new Date().toISOString() },
            { id: Date.now() + 2, text: 'Clique na checkbox para marcar como conclu칤da', completed: false, createdAt: new Date().toISOString() },
            { id: Date.now() + 3, text: 'Use os filtros para organizar suas tarefas', completed: false, createdAt: new Date().toISOString() }
        ];
        
        tasks = demoTasks;
        saveTasks();
    }
    
    console.log('Renderizando tarefas...', tasks.length);
    renderTasks();
    console.log('App inicializado com sucesso!');
});
